# NTDF Token End-to-End Test Plan

**Version**: 1.0
**Date**: 2025-10-31
**Status**: Ready for Execution

## Overview

This test plan validates the complete NTDF (NanoTDF-based) authentication token flow across the Arkavo ecosystem:
- **iOS App** (ArkavoSocial + ArkavoAgent) - Client
- **authnz-rs** - Authentication server (NTDF token generation)
- **arkavo-rs** - KAS/DRM server (NTDF token validation)
- **arkavo-edge** - Rust agent platform (discovered via mDNS)

## Test Environment

### Prerequisites

1. **iOS Device/Simulator**
   - iOS 26+ (ArkavoSocial requirement)
   - ArkavoAgent library integrated
   - OpenTDFKit integrated

2. **Backend Services**
   - arkavo-rs (KAS) running on `localhost:8443`
   - authnz-rs running (port TBD)
   - Both services configured with:
     - P-256 EC keys for NTDF
     - Ed25519 signing keys (optional for v1)
     - DPoP enabled

3. **arkavo-edge Agent**
   - Running locally with mDNS enabled
   - Advertises on `_a2a._tcp.local.`
   - WebSocket endpoint available

### Configuration

#### arkavo-rs (KAS)
```bash
export PORT=8443
export KAS_KEY_PATH=/path/to/kas_ec_private.pem  # P-256 private key
export NTDF_EXPECTED_AUDIENCE="https://localhost:8443"
export ENABLE_DPOP=true
export NATS_URL=nats://localhost:4222
export REDIS_URL=redis://localhost:6379
export RUST_LOG=info,arkavo_rs=debug
```

#### authnz-rs (IdP)
```bash
export PORT=8080  # Or configured port
export KAS_PUBLIC_KEY_PATH=/path/to/kas_ec_public.pem  # P-256 public key
export SIGNING_KEY_PATH=/path/to/ed25519_private.pem  # Ed25519 (optional)
export ENABLE_APP_ATTEST=true  # For iOS device attestation
```

#### arkavo-edge
```bash
# Start agent with default config
arkavo

# Agent should advertise:
# - Service: _a2a._tcp.local.
# - TXT: agent_id, purpose, model
# - WebSocket on port 3030 (or configured)
```

## Test Scenarios

### Scenario 1: Basic NTDF Token Generation and Validation

**Objective**: Verify end-to-end NTDF token flow without DPoP.

#### Test Steps

1. **iOS App Authentication**
   ```swift
   // In ArkavoSocial
   let deviceAttestation = await DeviceAttestationManager.shared.generateAttestation()

   // User authenticates via WebAuthn
   let authResult = await AuthenticationManager.authenticateWithWebAuthn(
       userId: "test-user-001"
   )
   ```

2. **NTDF Token Request**
   ```swift
   // iOS app sends PE + NPE attestation to authnz-rs
   let ntdfChain = await NTDFChainBuilder.createAuthorizationChain(
       userId: authResult.userId,
       authLevel: .webauthn,
       deviceAttestation: deviceAttestation
   )

   // Exchange with authnz-rs for Terminal Link
   let terminalLink = await exchangeForTerminalLink(
       originLink: ntdfChain.originLink,
       intermediateLink: ntdfChain.intermediateLink
   )
   // Returns: { "token": "NTDF <Z85>", "token_type": "NTDF", "expires_in": 3600 }
   ```

3. **WebSocket Connection to arkavo-rs**
   ```swift
   // Connect with NTDF token
   let ws = WebSocket(url: "ws://localhost:8443/ws")
   ws.setHeader("Authorization", value: "NTDF \(terminalLink.token)")
   await ws.connect()
   ```

4. **Expected Server Behavior**
   ```
   arkavo-rs logs:
   - "Validating NTDF token"
   - "Z85 decode successful"
   - "NTDF version: v1.3 (L1M)"
   - "ECDH key agreement successful"
   - "HKDF key derivation complete"
   - "AES-256-GCM decryption successful"
   - "NTDF token valid for WebSocket connection, user: <hex(sub_id)>"
   - "Subscribing to user-specific NATS subject: profile.<hex>"
   - "WebSocket upgrade accepted (101)"
   ```

5. **Verify Connection State**
   ```swift
   // iOS app should be connected
   XCTAssertTrue(ws.isConnected)

   // Server should have subscription
   // Check NATS subscription: profile.<hex(sub_id)>
   ```

#### Success Criteria
- ✅ NTDF token generated by authnz-rs
- ✅ Token is Z85-encoded, ~600-730 characters
- ✅ WebSocket upgrade succeeds (HTTP 101)
- ✅ Server logs show successful NTDF validation
- ✅ User-specific NATS subscription created

#### Failure Cases to Test
- ❌ **Expired token**: Set `exp` in past → expect 401
- ❌ **Invalid audience**: Wrong `aud` → expect 401
- ❌ **Malformed Z85**: Corrupt token → expect 401
- ❌ **Wrong KAS key**: Token encrypted for different KAS → decryption fails

---

### Scenario 2: HTTP Rewrap with NTDF + DPoP

**Objective**: Validate NTDF token with DPoP proof-of-possession for HTTP rewrap endpoint.

#### Test Steps

1. **Generate DPoP Proof**
   ```swift
   // iOS generates ephemeral ES256 key pair
   let dpopGenerator = DPoPGenerator()
   let dpopProof = try await dpopGenerator.generateProof(
       method: "POST",
       url: "https://localhost:8443/kas/v2/rewrap",
       accessToken: terminalLink.token,  // Z85-encoded NTDF token
       jti: UUID().uuidString
   )
   ```

2. **Create Rewrap Request**
   ```swift
   // Using OpenTDFKit to create rewrap request
   let nanotdf = try await NanoTDF.create(
       payload: "Test encrypted data".data(using: .utf8)!,
       kasURL: "https://localhost:8443"
   )

   let rewrapRequest = RewrapRequest(
       clientPublicKey: clientPublicKeyPEM,
       requests: [
           KeyAccessObject(
               header: nanotdf.header,
               keyId: nanotdf.keyAccessObjectId
           )
       ]
   )
   ```

3. **Send HTTP Request**
   ```http
   POST /kas/v2/rewrap HTTP/1.1
   Host: localhost:8443
   Content-Type: application/json
   Authorization: NTDF rGN.bK+V#7c@{h...
   DPoP: eyJhbGciOiJFUzI1NiIsInR5cCI6ImRwb3Aran...

   {
     "signed_request_token": "{\"clientPublicKey\":\"...\",\"requests\":[...]}"
   }
   ```

4. **Expected Server Behavior**
   ```
   arkavo-rs logs:
   - "Validating NTDF token"
   - "NTDF token valid for user: <hex(sub_id)>"
   - "Validating DPoP proof"
   - "DPoP typ: dpop+jwt"
   - "DPoP alg: ES256"
   - "Computing ath over Z85 token bytes"
   - "DPoP ath matches computed hash"
   - "DPoP JTI matches NTDF dpop_jti"
   - "DPoP proof valid: jti=<uuid>"
   - "Performing rewrap for key access object"
   - "Rewrap successful"
   ```

5. **Verify Response**
   ```json
   {
     "responses": [{
       "policyId": "uuid-or-hash",
       "results": [{
         "keyAccessObjectId": "kao-id",
         "status": "permit",
         "kasWrappedKey": "base64-encoded"
       }]
     }],
     "sessionPublicKey": "-----BEGIN PUBLIC KEY-----\n...",
     "schemaVersion": "1.0.0"
   }
   ```

6. **Decrypt Response**
   ```swift
   // iOS app unwraps the rewrapped key
   let wrappedKey = response.kasWrappedKey
   let dek = try await unwrapKey(wrappedKey, sessionKey: sessionSecret)

   // Decrypt payload
   let plaintext = try AES256GCM.decrypt(nanotdf.payload, key: dek)
   XCTAssertEqual(plaintext, "Test encrypted data")
   ```

#### Success Criteria
- ✅ DPoP proof generated correctly (ES256, jwk embedded)
- ✅ `ath` computed over Z85 token bytes (not decoded NanoTDF)
- ✅ Server validates DPoP method, URI, timestamp
- ✅ Server validates ath matches
- ✅ Server validates jti matches NTDF dpop_jti
- ✅ Rewrap succeeds, returns wrapped key
- ✅ iOS app can decrypt using rewrapped key

#### Failure Cases to Test
- ❌ **DPoP replay**: Reuse same DPoP proof → expect 401
- ❌ **Wrong ath**: Compute ath over decoded bytes → expect 401
- ❌ **JTI mismatch**: DPoP jti ≠ NTDF dpop_jti → expect 401
- ❌ **Expired DPoP**: iat > 60 seconds old → expect 401
- ❌ **Method mismatch**: DPoP htm="GET" but request is POST → expect 401

---

### Scenario 3: Agent Discovery and NTDF-Authenticated Communication

**Objective**: Discover arkavo-edge agent via mDNS and communicate using NTDF tokens.

#### Test Steps

1. **Start arkavo-edge Agent**
   ```bash
   # Terminal 1
   cd /path/to/arkavo-edge
   cargo run

   # Should output:
   # "Agent started: agent-abc123"
   # "mDNS advertising on _a2a._tcp.local."
   # "WebSocket listening on 0.0.0.0:3030"
   ```

2. **iOS App Discovery**
   ```swift
   // In ArkavoAgent
   let agentManager = AgentManager.shared
   agentManager.startDiscovery()

   // Wait for discovery
   await withCheckedContinuation { continuation in
       agentManager.$agents
           .filter { !$0.isEmpty }
           .sink { agents in
               print("Discovered \(agents.count) agents:")
               for agent in agents {
                   print("  - \(agent.metadata.name) (\(agent.metadata.model))")
               }
               continuation.resume()
           }
           .store(in: &cancellables)
   }
   ```

3. **Connect to Agent with NTDF**
   ```swift
   guard let agent = agentManager.agents.first else {
       XCTFail("No agents discovered")
       return
   }

   // Get NTDF token (from Scenario 1)
   let ntdfToken = terminalLink.token

   // Connect with Authorization header
   try await agentManager.connect(
       to: agent,
       headers: ["Authorization": "NTDF \(ntdfToken)"]
   )
   ```

4. **Send JSON-RPC Request**
   ```swift
   let response = try await agentManager.sendRequest(
       to: agent.id,
       method: "rpc.discover",
       params: [:]
   )

   switch response {
   case .success(_, let result):
       print("Agent capabilities: \(result)")
   case .error(_, let code, let message):
       XCTFail("RPC error \(code): \(message)")
   }
   ```

5. **Chat Session with NTDF**
   ```swift
   let chatManager = AgentChatSessionManager(agentManager: agentManager)

   // Open session (uses NTDF token from connection)
   let session = try await chatManager.openSession(with: agent.id)

   // Send message
   try await chatManager.sendMessage(
       sessionId: session.id,
       content: "What can you help me with?",
       attachments: nil
   )

   // Receive streaming response
   await chatManager.$messageDeltas
       .filter { $0[session.id] != nil }
       .sink { deltas in
           for delta in deltas[session.id]! {
               print("Agent: \(delta.content)")
           }
       }
       .store(in: &cancellables)
   ```

6. **arkavo-edge Agent Validation**
   ```
   Expected agent logs:
   - "WebSocket connection received"
   - "Extracting Authorization header"
   - "NTDF token detected"
   - "Validating NTDF token with arkavo-rs"  // Agent calls KAS
   - "Token valid for user: <sub_id>"
   - "Chat session opened: <session_id>"
   - "Processing message: What can you help me with?"
   - "Streaming response..."
   ```

#### Success Criteria
- ✅ iOS app discovers agent via mDNS (_a2a._tcp.local.)
- ✅ WebSocket connection established with NTDF token
- ✅ Agent validates token (calls arkavo-rs or has embedded validation)
- ✅ JSON-RPC requests succeed
- ✅ Chat session works with streaming deltas
- ✅ Agent identifies user from NTDF token claims

#### Integration Points
- **arkavo-edge** needs to:
  - Extract `Authorization: NTDF` header
  - Either validate locally OR forward to arkavo-rs for validation
  - Extract `sub_id` for user context
  - Use `session_id` for tracking

---

### Scenario 4: Policy Enforcement with NTDF Claims

**Objective**: Validate that policy contracts can access NTDF token claims for access control.

#### Test Steps

1. **Create TDF with Policy**
   ```swift
   // iOS app creates TDF with geofence policy
   let policy = Policy(
       uuid: UUID().uuidString,
       body: SharedResourceLocator(
           protocol: .sharedResource,
           body: "5H6sLwXKBv3cdm5VVRxrvA8p5cux2Rrni5CQ4GRyYKo4b9B4"  // geofence contract
       )
   )

   let nanotdf = try await NanoTDF.create(
       payload: "Restricted content".data(using: .utf8)!,
       kasURL: "https://localhost:8443",
       policy: policy
   )
   ```

2. **Attempt Rewrap with NTDF Token**
   ```swift
   // Send rewrap request with NTDF token
   let rewrapResponse = try await kasClient.rewrap(
       nanotdf: nanotdf,
       ntdfToken: terminalLink.token
   )
   ```

3. **Expected Server Behavior (Policy Evaluation)**
   ```
   arkavo-rs logs:
   - "Policy binding present"
   - "Evaluating contract: 5H6sLwXKBv3cdm5VVRxrvA8p5cux2Rrni5CQ4GRyYKo4b9B4"
   - "Extracting user identifier from NTDF claims"
   - "user_id: <hex(sub_id)>"
   - "Checking geofence contract"
   - "Location: [lat, lon, alt] (if available in claims)"
   - "Geofence check: PASS" (or FAIL)
   - "Policy contract approved access"
   ```

4. **Test with Different Claims**
   ```swift
   // Test subscription tier requirement
   // NTDF token has attrs: [(SubscriptionTier, 1)]  // basic
   // Policy requires: premium (2)
   // Expected: Access denied

   // Test age-gated content
   // NTDF token has attrs: [(Age, 25)]
   // Policy requires: Age >= 18
   // Expected: Access granted
   ```

#### Success Criteria
- ✅ Server extracts user_id from NTDF token (`hex(sub_id)`)
- ✅ Server uses NTDF flags for capability checks
- ✅ Server uses NTDF attrs for policy decisions
- ✅ Policy contracts correctly allow/deny based on claims
- ✅ Appropriate error messages returned on policy denial

#### Policy Contract Tests

| Policy Type | NTDF Claim | Expected Result |
|-------------|-----------|-----------------|
| Geofence | Location in claims | Allow if within bounds |
| ABAC | user_id matches policy | Allow if authorized |
| Content Rating | Age attribute >= 18 | Allow mature content |
| Subscription | SubscriptionTier >= required | Allow premium content |
| Device Security | PLATFORM_SECURE flag set | Allow on secure devices |

---

### Scenario 5: Token Lifecycle and Revocation

**Objective**: Test token expiration, refresh, and server-side revocation.

#### Test Steps

1. **Token Expiration**
   ```swift
   // Request NTDF token with short expiry
   let shortLivedToken = await requestNTDFToken(expiresIn: 5)  // 5 seconds

   // Use immediately
   let ws1 = try await connectWebSocket(token: shortLivedToken)
   XCTAssertTrue(ws1.isConnected)

   // Wait for expiration
   try await Task.sleep(nanoseconds: 6_000_000_000)  // 6 seconds

   // Attempt to use expired token
   let ws2 = try await connectWebSocket(token: shortLivedToken)
   // Expected: Connection refused with 401
   ```

2. **Server-Side Session Revocation**
   ```swift
   // Connect with NTDF token containing session_id
   let token1 = await requestNTDFToken(sessionId: "session-001")
   let ws = try await connectWebSocket(token: token1)

   // Server-side: Revoke session in Redis
   // redis-cli: DEL session:session-001

   // Attempt new connection with same session_id
   let token2 = await requestNTDFToken(sessionId: "session-001")
   let ws2 = try await connectWebSocket(token: token2)
   // Expected: Connection refused if session revoked
   ```

3. **Token Refresh Flow**
   ```swift
   // Initial token
   let initialToken = await requestNTDFToken(expiresIn: 10)

   // Before expiry, request refresh
   let refreshedToken = await refreshNTDFToken(
       oldToken: initialToken,
       refreshToken: refreshToken  // If OFFLINE_ACCESS flag set
   )

   // Use refreshed token
   let ws = try await connectWebSocket(token: refreshedToken)
   XCTAssertTrue(ws.isConnected)
   ```

#### Success Criteria
- ✅ Expired tokens rejected with 401
- ✅ Server logs: "Token expired: exp=<timestamp>, now=<timestamp>"
- ✅ Revoked sessions rejected (if session_id checked)
- ✅ Token refresh works when OFFLINE_ACCESS flag set
- ✅ New session_id generated on refresh

---

## Performance Benchmarks

### Target Metrics
- **NTDF Token Generation** (authnz-rs): < 50ms P95
- **NTDF Token Validation** (arkavo-rs): < 20ms P95
- **DPoP Validation**: < 10ms P95
- **WebSocket Upgrade**: < 100ms P95
- **HTTP Rewrap**: < 50ms P95 (excluding ECDH)

### Benchmark Tests

```swift
// iOS performance test
func testNTDFPerformance() async throws {
    let iterations = 100
    var validationTimes: [TimeInterval] = []

    for _ in 0..<iterations {
        let start = Date()

        // Full flow: generate DPoP + send rewrap
        let dpopProof = try await dpopGenerator.generateProof(/*...*/)
        let response = try await kasClient.rewrap(
            nanotdf: testNanoTDF,
            ntdfToken: ntdfToken,
            dpopProof: dpopProof
        )

        let elapsed = Date().timeIntervalSince(start)
        validationTimes.append(elapsed)
    }

    // Calculate P95
    let sorted = validationTimes.sorted()
    let p95Index = Int(Double(iterations) * 0.95)
    let p95 = sorted[p95Index]

    print("P95 latency: \(p95 * 1000)ms")
    XCTAssertLessThan(p95, 0.1)  // < 100ms
}
```

## Test Execution

### Phase 1: Unit Tests (Completed)
- ✅ NTDF payload serialization/deserialization
- ✅ Z85 encoding/decoding
- ✅ ECDH key agreement
- ✅ HKDF key derivation
- ✅ AES-256-GCM encryption/decryption
- ✅ DPoP proof generation
- ✅ DPoP proof validation

### Phase 2: Integration Tests (This Plan)

| Scenario | Priority | Status | Owner |
|----------|----------|--------|-------|
| 1. Basic NTDF Token | P0 | Ready | - |
| 2. HTTP Rewrap + DPoP | P0 | Ready | - |
| 3. Agent Discovery | P1 | Ready | - |
| 4. Policy Enforcement | P1 | Ready | - |
| 5. Token Lifecycle | P2 | Ready | - |

### Phase 3: Load Tests

```bash
# Load test HTTP rewrap endpoint
artillery run load-test.yml

# load-test.yml
scenarios:
  - name: "NTDF Rewrap"
    flow:
      - post:
          url: "/kas/v2/rewrap"
          headers:
            Authorization: "NTDF {{ ntdfToken }}"
            DPoP: "{{ dpopProof }}"
          json:
            signed_request_token: "{{ rewrapRequest }}"

# Target: 1000 req/s with P95 < 100ms
```

## Troubleshooting

### Common Issues

1. **401 Unauthorized on WebSocket Upgrade**
   - Check: NTDF token in Authorization header
   - Check: Token not expired (now < exp)
   - Check: Audience matches expected (aud == NTDF_EXPECTED_AUDIENCE)
   - Check: arkavo-rs logs for specific error

2. **DPoP Validation Failed**
   - Check: ath computed over Z85 bytes (not decoded)
   - Check: JTI matches NTDF dpop_jti
   - Check: Method/URI match request
   - Check: Timestamp within 60 seconds

3. **Agent Not Discovered**
   - Check: arkavo-edge running with mDNS enabled
   - Check: iOS app has NSLocalNetworkUsageDescription in Info.plist
   - Check: Both on same network
   - Check: Firewall allows mDNS (port 5353 UDP)

4. **Decryption Failed**
   - Check: Correct KAS private key loaded
   - Check: ECDH shared secret computed correctly
   - Check: HKDF salt matches NanoTDF version
   - Check: GCM authentication tag valid

### Debug Commands

```bash
# Check NTDF token structure
echo "NTDF rGN.bK+V#7c@{h..." | z85 decode | xxd

# Verify KAS public key
openssl ec -in kas_private.pem -pubout -text

# Test DPoP proof
curl -X POST https://localhost:8443/kas/v2/rewrap \
  -H "Authorization: NTDF <token>" \
  -H "DPoP: <proof>" \
  -d @rewrap-request.json -v

# Monitor NATS subscriptions
nats sub "profile.*"

# Check Redis sessions
redis-cli KEYS "session:*"
```

## Success Metrics

### Phase 2 Complete When:
- ✅ All 5 scenarios pass
- ✅ Performance benchmarks met
- ✅ Zero security vulnerabilities found
- ✅ Documentation updated with findings
- ✅ arkavo-edge integrated with NTDF validation

### Production Ready When:
- ✅ Load tests pass (1000 req/s)
- ✅ Security audit complete
- ✅ Monitoring/alerting configured
- ✅ Runbooks created
- ✅ Client SDKs updated

## Appendix A: Test Data

### Sample NTDF Token Payload (Decoded)

```json
{
  "sub_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "flags": 71,
  "scopes": ["openid", "profile", "email"],
  "attrs": [
    [0, 25],
    [1, 2],
    [2, 1],
    [3, 0]
  ],
  "dpop_jti": "9f8e7d6c-5b4a-3210-fedc-ba0987654321",
  "iat": 1698765432,
  "exp": 1698769032,
  "aud": "https://localhost:8443",
  "session_id": "f1e2d3c4-b5a6-7890-1234-567890abcdef",
  "device_id": "iPhone14,2",
  "did": "did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK"
}
```

**Decoded Flags** (71 = 0b01000111):
- PROFILE (bit 0)
- OPENID (bit 1)
- EMAIL (bit 2)
- WEBAUTHN (bit 6)

**Decoded Attributes**:
- Age: 25
- SubscriptionTier: 2 (premium)
- SecurityLevel: 1 (main)
- PlatformCode: 0 (iOS)

### Sample DPoP Proof

```json
{
  "typ": "dpop+jwt",
  "alg": "ES256",
  "jwk": {
    "kty": "EC",
    "crv": "P-256",
    "x": "l8tFrhx-34tV3hRICRDY9zCkDlpBhF42UQUfWVAWBFs",
    "y": "9VE4jf_Ok_o64zbTTlcuNJajHmt6v9TDVrU0CdvGRDA"
  }
}
.
{
  "jti": "9f8e7d6c-5b4a-3210-fedc-ba0987654321",
  "htm": "POST",
  "htu": "https://localhost:8443/kas/v2/rewrap",
  "iat": 1698765432,
  "ath": "fUHyO2r2Z3NH9bGZnK5gZQ7vqvVEQqGt5QzYqY4qV6s"
}
.
<ES256-signature>
```

## Appendix B: Reference Implementation

See:
- iOS: `app/ArkavoSocial/Sources/ArkavoSocial/NTDFChainBuilder.swift`
- iOS: `app/ArkavoAgent/Sources/ArkavoAgent/AgentManager.swift`
- Server: `arkavo-rs/src/modules/terminal_link_ntdf.rs`
- Server: `arkavo-rs/src/modules/dpop.rs`
- Spec: `specifications/ntdf-token/draft-arkavo-ntdf-token-00.md`
